---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getSubscriberCount, formatSubscriberCount } from '../../lib/kit';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await render(article);

// Get subscriber count
const subscriberCount = await getSubscriberCount();
const formattedCount = formatSubscriberCount(subscriberCount);

// Calculate reading time (average 200 words per minute)
const wordsPerMinute = 200;
const wordCount = article.body.split(/\s+/).length;
const readingTime = Math.max(1, Math.ceil(wordCount / wordsPerMinute));

// Get recommended articles (prioritize same category, then random)
const allArticles = await getCollection('articles');
const otherArticles = allArticles.filter(a => a.slug !== article.slug && a.data.image);

// Split into same category and different category
const sameCategory = otherArticles
  .filter(a => a.data.category === article.data.category)
  .sort(() => Math.random() - 0.5);

const differentCategory = otherArticles
  .filter(a => a.data.category !== article.data.category)
  .sort(() => Math.random() - 0.5);

// Combine: same category first, then fill with others
const recommendedArticles = [...sameCategory, ...differentCategory].slice(0, 3);
---

<Layout
  title={`${article.data.title} - Approachable Design`}
  description={article.data.description}
  ogImage={article.data.image}
  variant="light"
>
  <article class="py-16 md:py-24">
    <div class="container">
      <!-- Header - Full Width -->
      <div class="max-w-3xl mx-auto lg:max-w-none lg:mx-0">
        <header class="mb-12 max-w-4xl mx-auto text-center">
          <div class="flex items-center justify-center gap-2 text-sm font-medium uppercase tracking-wider mb-4">
            <span class="text-brand-dark/60">{readingTime} min read</span>
            {article.data.category && (
              <>
                <span class="text-brand-dark/40">â€¢</span>
                <span class="text-brand-dark/60">{article.data.category.replace('-', ' ')}</span>
              </>
            )}
          </div>
          <h1 class="text-balance font-display-black-italic text-5xl md:text-6xl lg:text-7xl text-brand-dark mb-4">
            {article.data.title}
          </h1>
          {article.data.description && (
            <p class="text-xl text-brand-dark/70 mb-6">
              {article.data.description}
            </p>
          )}
          <div class="flex items-center justify-center gap-3">
            <img
              src="/images/site/nate-avatar.avif"
              alt="Nate Kadlac"
              class="w-10 h-10 rounded-full object-cover"
            />
            <span class="text-brand-dark/80">By Nate Kadlac</span>
          </div>
        </header>
      </div>

      <!-- Two Column Layout -->
      <div class="lg:flex lg:gap-12">
        <!-- Main Content -->
        <div class="lg:flex-1 max-w-3xl">
          <!-- Featured Image -->
          {article.data.image && (
            <img
              src={article.data.image}
              alt={article.data.title}
              class="w-full rounded-2xl mb-12"
            />
          )}

          <!-- Content -->
          <div class="prose prose-light">
            <Content />
          </div>

          <!-- Back link -->
          <div class="mt-16 pt-8 border-t border-brand-dark/10">
            <a href="/articles" class="text-brand-purple hover:underline">
              &larr; Back to all articles
            </a>
          </div>

          <!-- Recommended Articles -->
          {recommendedArticles.length > 0 && (
            <div class="mt-16 pt-8 border-t border-brand-dark/10">
              <h2 class="font-heading font-bold text-sm uppercase tracking-wider text-brand-dark mb-8">
                The next three articles you should read
              </h2>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                {recommendedArticles.map((rec) => (
                  <a href={`/articles/${rec.slug}`} class="group block">
                    {rec.data.image && (
                      <div class="aspect-[4/3] overflow-hidden rounded-xl mb-3">
                        <img
                          src={rec.data.image}
                          alt={rec.data.title}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                    )}
                    <h3 class="font-heading font-semibold text-brand-dark group-hover:text-brand-purple transition-colors">
                      {rec.data.title}
                    </h3>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Mobile Opt-in Form (hidden on lg+) -->
          <div class="lg:hidden mt-16 pt-8 border-t border-brand-dark/10">
            <div class="bg-white rounded-2xl border border-brand-dark/10 p-6 shadow-sm">
              <!-- Header Image -->
              <img
                src="/images/site/makeityours-opt-in.avif"
                alt="Make it yours"
                class="w-full h-auto max-h-48 object-cover object-center rounded-xl mb-6"
              />

              <!-- Headline -->
              <p class="text-brand-dark text-base mb-4">
                Join {formattedCount}+ weekly readers who are:
              </p>

              <!-- Bullet Points -->
              <ul class="space-y-2 mb-6 text-brand-dark/80 text-base list-disc list-inside marker:text-brand-purple">
                <li>Building trust with personalized branding</li>
                <li>Increasing sales with premium packaging</li>
                <li>Creating clear offers that convert</li>
              </ul>

              <!-- Subhead -->
              <p class="text-brand-dark/70 text-base mb-4">
                Get dollar-driven design tips in your inbox 2-3x a week.
              </p>

              <!-- Form -->
              <form
                action="https://app.kit.com/forms/5311138/subscriptions"
                method="post"
                class="space-y-3"
              >
                <input
                  type="email"
                  name="email_address"
                  placeholder="Your best email"
                  required
                  class="w-full px-4 py-3 rounded-xl bg-brand-dark/5 border-0 text-brand-dark placeholder:text-brand-dark/40 focus:outline-none focus:ring-2 focus:ring-brand-purple"
                />
                <button
                  type="submit"
                  class="w-full bg-brand-purple text-white font-heading font-semibold py-3 px-6 rounded-xl hover:bg-brand-purple-light transition-colors"
                >
                  Upgrade Your Design Eye
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Sticky Sidebar -->
        <aside class="hidden lg:block lg:w-80 xl:w-96 flex-shrink-0">
          <div class="sticky top-8">
            <div class="bg-white rounded-2xl border border-brand-dark/10 p-6 shadow-sm">
              <!-- Header Image -->
              <img
                src="/images/site/makeityours-opt-in.avif"
                alt="Make it yours"
                class="w-full h-auto max-h-48 object-cover object-center rounded-xl mb-6"
              />

              <!-- Headline -->
              <p class="text-brand-dark text-base mb-4">
                Join {formattedCount}+ weekly readers who are:
              </p>

              <!-- Bullet Points -->
              <ul class="space-y-2 mb-6 text-brand-dark/80 text-base list-disc list-inside marker:text-brand-purple">
                <li>Building trust with personalized branding</li>
                <li>Increasing sales with premium packaging</li>
                <li>Creating clear offers that convert</li>
              </ul>

              <!-- Subhead -->
              <p class="text-brand-dark/70 text-base mb-4">
                Get dollar-driven design tips in your inbox 2-3x a week.
              </p>

              <!-- Form -->
              <form
                action="https://app.kit.com/forms/5311138/subscriptions"
                method="post"
                class="space-y-3"
              >
                <input
                  type="email"
                  name="email_address"
                  placeholder="Your best email"
                  required
                  class="w-full px-4 py-3 rounded-xl bg-brand-dark/5 border-0 text-brand-dark placeholder:text-brand-dark/40 focus:outline-none focus:ring-2 focus:ring-brand-purple"
                />
                <button
                  type="submit"
                  class="w-full bg-brand-purple text-white font-heading font-semibold py-3 px-6 rounded-xl hover:bg-brand-purple-light transition-colors"
                >
                  Upgrade Your Design Eye
                </button>
              </form>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </article>
</Layout>

<style>
  .font-display-black-italic {
    font-family: var(--font-display-black-italic);
  }
  .prose-light {
    color: #0B0A16;
  }
  .prose-light :global(p) {
    color: rgba(11, 10, 22, 0.8);
  }
  .prose-light :global(strong) {
    color: #0B0A16;
  }
  .prose-light :global(h1),
  .prose-light :global(h2),
  .prose-light :global(h3) {
    color: #0B0A16;
  }
  .prose-light :global(ul),
  .prose-light :global(ol) {
    color: rgba(11, 10, 22, 0.8);
  }
  .prose-light :global(ul li),
  .prose-light :global(ol li) {
    color: rgba(11, 10, 22, 0.8);
  }
  .prose-light :global(a) {
    color: #5148CA;
  }
  .prose-light :global(blockquote) {
    color: rgba(11, 10, 22, 0.7);
    border-left-color: #5148CA;
  }
  .prose-light :global(hr) {
    border-top-color: rgba(11, 10, 22, 0.2);
  }
  .prose-light :global(code) {
    background-color: rgba(11, 10, 22, 0.1);
    color: #0B0A16;
  }
  .prose-light :global(pre) {
    background-color: rgba(11, 10, 22, 0.05);
  }
</style>
